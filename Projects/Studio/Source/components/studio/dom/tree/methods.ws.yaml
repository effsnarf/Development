dom:
  div:

props:
  userApp:

mounted: | #js
  function() {
    const methods = this.$options.methods;
    for (const methodName in methods)
    {
      const method = methods[methodName].bind(this);
      this.$root[methodName] = method;
    }
  }

methods:
  getBoundData: | #js
    function(node, dataItem, defaultValue) {
      const ds = node?.data?.source;
      if ((!ds) || (!dataItem)) return defaultValue;
      if (ds?.type == "state.tree.link")
      {
        return Objects.getProperty(this.$root.global.app.state, ds.path);
      }
      if (ds.type == "data.item")
      {
        if (ds.exp in dataItem) return dataItem[ds.exp];
        const localVars = this.objectsToLocalVars([{obj: this.$root.global.app.state }, { obj: dataItem, keys: ds.exp.getWords() }]);
        try {
          const func = eval(`(function() {
          ${localVars.join('\n')}
            return ${ds.exp};
          })`);
          return func();
        }
        catch (ex) {
          debugger;
          console.warn(ex);
          return defaultValue;
        }
      }
      throw `Unknown data source`;
    }
  objectsToLocalVars: | #js
    function(args) {
      const vars = [];
      for (const arg of args) {
        const obj = arg.obj;
        const keys = (arg.keys || Object.keys(obj));
        for (const key of keys) if (key in obj) vars.push(`const ${key} = ${JSON.stringify(obj[key])};`);
      }
      return vars;
    }
  getNodeIcon: | #js
    function(node) {
      const icons = {
        "user.app": "ðŸ’»",
        layouts: "ðŸ“„",
        layout: "ðŸ“„",
        pages: "ðŸ“ƒ",
        page: "ðŸ“„",
        panel: "ðŸ—‚ï¸",
        title: "ðŸ…°ï¸",
        list: "ðŸŸ°",
        comps: "ðŸŽ",
        comp: "ðŸŽ",
        "comp.inst": "ðŸ“¦",
        image: "ðŸ–¼ï¸",
        "slot.outlet": "ðŸ§©",
        "slot.content": "ðŸ§©ðŸ§Š",
        vars: "ðŸ“‚ðŸƒ",
        var: "ðŸ§Š"
      };
      return (icons[node.type] || "â”");
    }
  findNode: | #js
    function(node, type, compName) {
      for (const childNode of node.children) {
        if (childNode.type != type) continue;
        // found the node by type
        if ((type == "comp") && compName) {
          if (compName != childNode.name) continue;
        }
        return childNode;
      }
    }
  findNodeByPath: | #js
    function(nodePath) {
      if (typeof(nodePath) == 'string') nodePath = nodePath.split('.');
      let node = this.userApp;
      let part;
      while (part = nodePath.shift()) {
        node = this.findNodeByName(node, part);
      }
      return node;
    }
  findNodeByName: | #js
    function(parent, name) {
      return parent.children?.find(c => (name == (c.name || c.type)));
    }
  findDescNodes: | #js
    function(parent, type) {
      const nodes = [];
      const search = (node) => {
        if (nodes.map(n => n.id).includes(node.id)) return;
        if (type == node.type) nodes.push(node);
      };
      Objects.traverse(parent, search);
      return nodes;
    }
  getNodes: | #js
    function(parentNode, type) {
      const nodes = [];
      for (const childNode of parentNode.children) {
        if (type == childNode.type) nodes.push(childNode);
      }
      return nodes;
    }
  getCompNode: | #js
    function(compInstNode) {
      return this.getClassNode("comp", compInstNode.comp);
    }
  getNodesByType: | #js
    function(type) {
      const folderNode = this.findNode(this.userApp, type.pluralize());
      const itemNodes = this.getNodes(folderNode, type);
      return itemNodes;
    }
  getRefingNodes: | #js
    function(varPath) {
      const refs = [];
      if (!varPath.includes(".selected")) return [];
      return TreeObject.filter(this.userApp, (n) => (n.data?.source?.path?.join('.').startsWith(varPath)));
    }
  getPageNodes: | #js
    function() {
      return this.getNodesByType("page");
    }
  getLayoutNodes: | #js
    function() {
      return this.getNodesByType("layout");
    }
  getClassNode: | #js
    function(type, inst) {
      const folderNodes = this.getNodesByType(type);
      return folderNodes.find(cls => (cls.name == inst.name));
    }
  getPageNames: | #js
    function() {
      const pageNodes = this.getNodesByType("page");
      return pageNodes.map(p => p.name);
    }
  getNodePageName: | #js
    function(node) {
      const ancs = this.getNodeAncestors(node);
      return ancs.find(n => (n.type == "page"))?.name;
    }
  getContainingPageNode: | #js
    function(node) {
      const ancs = this.getNodeAncestors(node);
      return ancs.find(n => (n.type == "page"));
    }
  getNodeAncestors: | #js
    // #TODO Slow
    function(node, ancs = []) {
      while (node = this.getNodeParent(node)) ancs.unshift(node);
      return ancs;
    }
  getNodeParent: | #js
    // #TODO Slow
    function(node) {
      return TreeObject.find(this.userApp, (p => (p.children?.map(c => c.id).includes(node.id))));
    }
