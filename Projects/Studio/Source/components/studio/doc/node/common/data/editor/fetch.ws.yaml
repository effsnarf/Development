dom:
  div:
    :key: key1
    ui.input.text.box:
      hint: "https://a.4cdn.org/boards.json"
      multiline: true
      :value: initial.url
      @input: (value) => url = value
    div:
      v-if: (true) || (url != initial.url)
      ui.button:
        icon: ✔️
        text: save
        @click: onSaveUrl
    div:
      studio.app.runtime.state.branch:
        :node: node
        :node-var-path: nodeVarPath
        :user-app-state: userAppState
        :field-names: "{ _url: '🌐 url', _value: '🌐🧊 fetched data', value: '🔎🧊 linqd data' }"
        template:
          v-slot: after__url
          div:
            v-if: (nodeVarData?._value)
            h3:
              title: The fetched data can be transformed using a LINQ expression.
              v-text: "'🧊🔎 linq'"
            ui.linq:
              :style: "{ margin: 'auto' }"
              :input: nodeVarData._value
              :value: initial.linq
              @input: setLinq
              @output: (value) => nodeVarLinqedData = value

props:
  node:
  nodeVar:
  nodeVarPath:
  userAppState:

data:
  url:
  initial:
    url:
    linq:
  nodeVarData:
  nodeVarLinqedData:
  key1: 1

mounted: | #js
  function() {
    this.$root.e.on("app.node.changed", this.onAppNodeChanged.bind(this));
    this.$root.e.on("app.state.changed", this.onAppStateChanged.bind(this));
    this.refresh();
  }

methods:
  onAppNodeChanged: | #js
    function(node) {
      if (node.id != this.node.id) return;
      this.refresh();
    }
  onAppStateChanged: | #js
    function(vars) {
      const var1 = vars.find(v => (this.nodeVarPath == v.varPath.join(".")));
      if (!var1) return;
      this.refresh();
    }
  setLinq: | #js
    function(linq) {
      if (Objects.areEqual(linq, this.initial.linq)) return;
      this.initial.linq = Objects.clone(linq);
      this.$root.do("edit.node.var", { node: this.node, varName: this.nodeVar.name, key: "linq", value: linq });
    }
  onSaveUrl: | #js
    function() {
      this.$root.do("edit.node.var", { node: this.node, varName: this.nodeVar.name, key: "url", value: this.url });
    }
  refresh: | #js
    function(nodeVar) {
      if (!nodeVar) nodeVar = this.nodeVar;
      this.initial.linq = Objects.clone(nodeVar.linq);
      this.initial.url = this.url = this.nodeVar?.url;
      this.nodeVarData = Objects.getProperty(this.userAppState, this.nodeVarPath);
      this.key1++;
    }

watch:
  nodeVar:
    immediate: true
    handler: | #js
      function(nodeVar) {
        this.refresh(nodeVar);
      }
