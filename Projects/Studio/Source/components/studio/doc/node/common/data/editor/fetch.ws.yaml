dom:
  div:
    :key: key1
    ui.input.text.box:
      hint: url
      multiline: true
      v-model: url
    div:
      v-if: (true) || (url != initial.url)
      ui.button:
        icon: ✔️
        text: save
        @click: onSaveUrl
    div:
      ui.value.preview:
        :value: nodeVarData
      div:
        ui.linq:
          v-if: (nodeVarData)
          :input: nodeVarData._value
          :value: initial.linq
          @input: setLinq
          @output: (value) => nodeVarLinqedData = value

props:
  node:
  nodeVar:
  nodeVarPath:
  userAppState:

data:
  url:
  initial:
    url:
    linq:
  nodeVarData:
  nodeVarLinqedData:
  key1: 1

mounted: | #js
  function() {
    this.$root.e.on("app.state.changed", this.onAppStateChanged.bind(this));
    this.refresh();
  }

methods:
  onAppStateChanged: | #js
    function(vars) {
      const var1 = vars.find(v => (this.nodeVarPath == v.varPath.join(".")));
      if (!var1) return;
      this.refresh();
    }
  setLinq: | #js
    function(linq) {
      if (Objects.areEqual(linq, this.initial.linq)) return;
      this.initial.linq = Objects.clone(linq);
      this.$root.do("edit.node.var", { node: this.node, varName: this.nodeVar.name, key: "linq", value: linq });
    }
  onSaveUrl: | #js
    function() {
      this.$root.do("edit.node.var", { node: this.node, varName: this.nodeVar.name, key: "url", value: this.url });
    }
  refresh: | #js
    function() {
      this.nodeVarData = Objects.getProperty(this.userAppState, this.nodeVarPath);
      this.key1++;
    }

watch:
  nodeVar:
    immediate: true
    handler: | #js
      function(nodeVar) {
        this.initial.linq = Objects.clone(nodeVar.linq);
        this.initial.url = this.url = this.nodeVar?.url;
        this.refresh();
      }
