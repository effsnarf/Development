dom:
  div:
    .absolute:
      studio.app.logo:
    .spacer0:
      v-text: "''"
    div:
      :style: "{ width: 'fit-content', 'max-height': '15em', overflow: 'auto', margin: 'auto' }"
      studio.app.runtime.log:
        v-if: "false"
    div:
      :style: "{ 'margin-bottom': '2em' }"
      studio.doc.node.toolbar:
        :user-app: userApp
    .spacer1:
      v-text: "''"
    .main-boxes:
      v-if: (userApp && is.inited)
      :class: "{ ['box-hovered-' + sui.main.box.hovered]: true }"
      .main-box.a:
        ide.vue.debugger:
        @mouseenter: sui.main.box.hovered = 0
        @mouseleave: sui.main.box.hovered = null
      .main-box.b:
        studio.app.ui.drawer:
          closed-width: 8em
        div:
          :style: "{ 'margin-top': 'calc(-2.2em)' }"
          studio.dom.node.browser:
            :user-app: userApp
            :user-app-state: userAppState
            :sui: sui
        studio.app.log:
          category: runtime
        @mouseenter: sui.main.box.hovered = 1
        @mouseleave: sui.main.box.hovered = null
      .main-box.c:
        studio.app.ui.drawer:
          closed-width: 8em
        .box2:
          class: flex-grow-1
          :class: "{ 'user-app-tilted': sui.app.is.tilted }"
          @mouseenter: () => onHoverApp(true)
          @mouseleave: () => onHoverApp(false)
          studio.doc.node.picker:
            v-if: "false"
            :user-app: userApp
            :sui: sui
            :enabled: sui.app.is.hovered
          studio.app.runtime:
            ref: userAppRuntime1
            :user-app: userApp
            :sui: sui
            @user-app-state: (uas) => userAppState = uas
          div:
            v-text: sui.node.hovered?.id
        @mouseenter: sui.main.box.hovered = 2
        @mouseleave: sui.main.box.hovered = null
      .main-box.d:
        div:
          :style: "{ 'margin-top': '-2em', height: '2em', 'pointer-events': 'none' }"
          transition:
            name: slide
            h2:
              :key: sui.node.selecteds?.[sui.node.selecteds?.length-1]?.id
              studio.dom.tree.node:
                :item: sui.node.selecteds?.[sui.node.selecteds?.length-1]
                :sui: sui
                :dropzone: "false"
        .box2:
          studio.doc.node.editor:
            :node: sui.node.selecteds[sui.node.selecteds.length-1]
            :user-app: userApp
            :user-app-state: userAppState
            :sui: sui
            :is-tabs-drawer-open: "true"
        @mouseenter: sui.main.box.hovered = 3
        @mouseleave: sui.main.box.hovered = null
      .main-box.e:
        studio.app.global.settings:
          :user-app: userApp
          :user-app-state: userAppState
          :sui: sui
        div:
          .spacer2:
            v-text: "''"
          studio.app.action.stack:
            :user-app: userApp
            :sui: sui
        @mouseenter: sui.main.box.hovered = 4
        @mouseleave: sui.main.box.hovered = null
    .logo:
      v-text: "''"
    studio.dom.tree.methods:
      ref: methods1
      :user-app: userApp
    studio.app.ui.trash.can:
      :user-app: userApp
    ui.css.stylesheet:
      :rules: appStylesheet

data:
  userApp:
  userAppState:
  remote:
    userApp:
  sui:
    app:
      is:
        hovered:
        tilted:
    grid:
      lines:
    tool:
      category:
        index:
        name:
        options: ['🍃 node', '🧊 data', '🧱 layout', '🎨 design', '✨ animation', '⚡ events']
        icons: ['🍃', '🧊', '🧱', '🎨', '✨', '⚡']
      grid:
        lines: false
    main:
      box:
        hovered: null
    design:
      selected:
        tab: 
        moods:
    page:
      selected:
      trans:
        dir:
        preview: false
    pages:
    node:
      hovered:
      selecteds: []
      active:
      context:
      tree:
        is:
          hovered:
    nodes:
      hovered:
    selected:
      dataItems: []
    debug: true
  is:
    inited: false
  pageNodes:
  appStateChangedVars: []
  appStateChangeKey: 1

mounted: | #js
  async function() {
    const _dbp = (new DatabaseProxy("http://localhost:4041/IdeStudio"));
    this.$root.data = {
      _dbp,
      _storage: (entities) => (new Data2.DatabaseProxyStorage(_dbp, entities.capitalize(), { userID: 1 })),
      vue: {
        reactive: async (entities, vue, key, defaultValue, options) => (await this.$root.data._storage(entities).vue.reactive(vue, key, defaultValue, options)),
      },
      array: async (entities, array) => (await this.$root.data._storage(entities).array(entities, array, 20)),
    };

    const mockUserApp = this.getMockupUserApp();
    this.userApp = mockUserApp;
    this.remote.userApp = (await this.$root.data.vue.reactive("UserApps", this, "userApp", mockUserApp, { allowNull: false }));

    await this.$nextTick();
    this.pageNodes = this.$root.getPageNodes();
    // Register global methods
    this.$root.getUserApp = this.getUserApp.bind(this);
    this.$root.getStudioApp = this.getStudioApp.bind(this);
    this.$root.studio = {
      user: {
        app: {
          state: {
            get: (varPath) => {
              return Objects.getProperty(this.userAppState, varPath);
            },
            set: (vue, ...args) => {
              // it's either (varPath, newValue) or (varPath, varName, newValue)
              let varPath, varName, newValue;
              if (args.length == 2) {
                [varPath, newValue] = args;
              } else {
                [varPath, varName, newValue] = args;
              }
              if (Array.isArray(varPath)) varPath = varPath.join('.');
              if (!varName) {
                // extract varName from varPath
                varName = varPath.split('.').last();
                // remove varName from varPath
                varPath = varPath.split('.').slice(0, -1).join('.');
              }
              varPath = (varPath.split?.('.') || varPath);
              if (varPath.join(".") == "home.list1") debugger;
              const fullVarPath = varPath.concat([varName]).join('.');
              const oldValue = Objects.getProperty(this.userAppState, fullVarPath);
              if (newValue == oldValue) return;
              Objects.setProperty(this.userAppState, fullVarPath, newValue);
              this.appStateChangedVars.push({ varPath, newValue });
              this.appStateChangeKey++;
              //console.log("🧊", fullVarPath, newValue);
              //this.$root.e.emit("app.log", vue, "🧊", "app.state.set", { varPath, varName, newValue });
            },
          },
          log: (vue, icon, method, data) => {
            this.$root.e.emit("app.log", vue, icon, method, data);
          }
        },
        comp: {
          state: {
            change: ($root, vue, key, varPath, newValue) => {
              $root.studio.user.app.state.set(this, varPath, newValue);
            }
          }
        }
      }
    }
    this.$watch("sui.page.selected", this.onSelectedPageChanged.bind(this));
    this.$watch("sui.node.hovered", this.onHoveredNodeChanged.bind(this));
    this.$root.e.on("sui.node.selecteds", this.onSuiNodeSelecteds.bind(this));
    this.is.inited = true;
  }

methods:
  onSelectedPageChanged: | #js
    function(pageNode) {
      if (!pageNode) return;
      this.initPageUiState(pageNode);
      const sui = this.sui;
      const page = sui.pages[pageNode.id];
      // when switching page, set the selected node to the page's selected node
      sui.node.selected = page.node.selected;
    }
  onHoveredNodeChanged: | #js
    function(node) {
      if (!node) {
        //document.querySelectorAll(".hovered-node").forEach(n => n.classList.remove("hovered-node"));
        return;
      }
      //const els = document.querySelectorAll(`[data-node-id="${node.id}"]`);
      //els.forEach(n => n.classList.add("hovered-node"));
    }
  onSuiNodeSelecteds: | #js
    function(selecteds) {
      const node = selecteds.last();
      this.sui.selected.dataItems.clear();
    }
  initPageUiState: | #js
    function(pageNode) {
      if (!pageNode) return;
      // init sui.pages[(page-id)] to hold separate ui state for pages
      const sui = this.sui;
      sui.pages = (sui.pages || {});
      sui.pages[pageNode.id] = (this.sui.pages[pageNode.id] || {});
      const page = sui.pages[pageNode.id];
      page.node = (page.node || {});
      page.node.selected = (page.node.selected || null);
    }
  onHoverApp: | #js
    function(isHovered) {
      this.sui.app.is.hovered = isHovered;
    }
  getPageTransDir: | #js
    function(fromPage, toPage) {
      if (!fromPage?.id || !toPage?.id) return null;
      if (toPage.id > fromPage.id) return "next";
      if (fromPage.id > toPage.id) return "prev";
    }
  onSuiEvent: | #js
    function(suiFunc) {
      suiFunc(this.sui);
    }
  onDomEditEvent: | #js
    function(editFunc) {
      editFunc();
    }
  getMockupUserApp: | #js
    function() {
      const mgUserApp = {
        type: "user.app",
        global: {
          design: {
            palette: null
          },
          page: {
            anim: {
              "name": "slide-x",
              "enter": {
                "from": {
                  "transform": "translateX(100%)",
                  "opacity": 0
                }
              },
              "leave": {
                "to": {
                  "transform": "translateX(-100%)",
                  "opacity": 0
                }
              }
            }
          }
        },
        children: [
          {
            type: "page.templates",
            children: [
              {
                type: "page.template",
                name: "default",
                children: [
                  {
                    type: "panel",
                    layout: {
                      position: "fixed",
                      top: 0
                    },
                    children: [
                      {
                        type: "text",
                        text: "4chan viewer",
                        size: 3
                      },
                      {
                        type: "slot.outlet",
                        name: "header"
                      }
                    ]
                  },
                  {
                    type: "panel",
                    layout: {
                      position: "fixed",
                      top: "10vh",
                      size: {
                        height: "90vh"
                      }
                    },
                    children: [
                      {
                        type: "slot.outlet",
                        name: "content"
                      }
                    ]
                  },
                ]
              }
            ]
          },
          {
            type: "pages",
            children: [
              {
                type: "page",
                name: "home",
                page: {
                  template: {
                    name: "default"
                  }
                },
                children: [
                  {
                    type: "slot.content",
                    slot: {
                      name: "header"
                    },
                    children: [
                      {
                        type: "text",
                        size: 1,
                        vars: [
                          {
                            name: "text",
                            type: "value",
                            value: "Home page"
                          }
                        ]
                      },
                    ]
                  },
                  {
                    type: "slot.content",
                    slot: {
                      name: "content"
                    },
                    children: [
                      {
                        type: "panel",
                        layout: {
                          type: "grid.y"
                        },
                        children: [
                          {
                            type: "ui.input.text.box",
                            name: "query",
                            vue: {
                              props: {
                                type: "search",
                                hint: "search",
                                icon: "🔎",
                              }
                            },
                            vars: [
                              {
                                name: "text",
                                type: "node.prop",
                                value: "hello",
                                vModel: true
                              }
                            ]
                          },
                          {
                            type: "ui.button",
                            name: "button1",
                            events: [
                              {
                                name: "click",
                                handler: {
                                  args: [],
                                  code: `$node.clickCount = ($node.clickCount??0) + 1; \n alertify.message(\`clicked (\${$node.clickCount})\`);`,
                                },
                              }
                            ],
                            vue: {
                              props: {
                                icon: "👆",
                                //text: "click me",
                              }
                            },
                            vars: [
                              {
                                name: "text",
                                type: "exp",
                                exp: "`click me (${$node.clickCount})`",
                              },
                              {
                                name: "clickCount",
                                type: "value",
                                value: 0
                              }
                            ]
                          },
                        ]
                      },
                      {
                        type: "list",
                        name: "boards",
                        vars: [
                          {
                            name: "items",
                            type: "fetch",
                            url: "`https://a.4cdn.org/boards.json`",
                            linq: [{"type":"select.field","path":["boards"],"_id":1},{"type":"select.fields","fields":["board","title"],"_id":2}]
                          },
                          {
                            name: "hovered",
                            type: "node.prop",
                            editable: false
                          },
                          {
                            name: "selected",
                            type: "node.prop",
                            editable: false
                          }
                        ],
                        children: [
                          {
                            type: "text",
                            size: 2,
                            vars: [
                              {
                                name: "text",
                                type: "field",
                                exp: "title"
                              }
                            ]
                          }
                        ]
                      },
                    ]
                  },
                ]
              },
              {
                type: "page",
                name: "board",
                page: {
                  template: {
                    name: "default"
                  }
                },
                children: [
                  {
                    type: "slot.content",
                    slot: {
                      name: "header"
                    },
                    children: [
                      {
                        type: "text",
                        size: 1,
                        vars: [
                          {
                            name: "text",
                            type: "exp",
                            exp: "$app.home.boards.selected?.title",
                          }
                        ]
                      },
                    ]
                  },
                  {
                    type: "slot.content",
                    slot: {
                      name: "content"
                    },
                    children: [
                      {
                        type: "list",
                        name: "threads",
                        vars: [
                          {
                            name: "items",
                            type: "fetch",
                            url: "((!$app.home.boards.selected) ? null : `https://a.4cdn.org/${$app.home.boards.selected.board}/catalog.json`)",
                            linq: [{"type":"select.fields","fields":["threads"],"_id":1},{"type":"flat.map","path":["threads"],"_id":2}]
                          },
                          {
                            name: "hovered",
                            type: "node.prop",
                            editable: false
                          },
                          {
                            name: "selected",
                            type: "node.prop",
                            editable: false
                          }
                        ],
                        children: [
                          {
                            type: "comp.inst",
                            comp: {
                              name: "thread.teaser"
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                type: "page",
                name: "thread",
                page: {
                  template: {
                    name: "default"
                  }
                },
                children: [
                  {
                    type: "slot.content",
                    slot: {
                      name: "header"
                    },
                    children: [
                      {
                        type: "text",
                        size: 1,
                        vars: [
                          {
                            name: "text",
                            type: "exp",
                            exp: "$app.board.threads.selected?.sub"
                          }
                        ]
                      },
                    ]
                  },
                  {
                    type: "slot.content",
                    slot: {
                      name: "content"
                    },
                    children: [
                      {
                        type: "list",
                        name: "posts",
                        data: {
                          vars: [
                            {
                              name: "items",
                              type: "fetch",
                              url: "`https://a.4cdn.org/${$app.home.boards.selected?.board}/thread/${$page.threads.selected?.no}.json`",
                              linq: [ { "type": "select.field", "path": [ "posts" ], "_id": 1 } ]
                            }
                          ],
                        },
                        children: [
                          {
                            type: "comp.inst",
                            comp: {
                              name: "post"
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            type: "comps",
            children: [
              {
                type: "comp",
                name: "thread.teaser",
                children: [
                  {
                    type: "panel",
                    layout: {
                      type: "grid.uniform",
                      grid: {
                        name: "3 x …",
                        template: {
                          columns: "repeat(3, 1fr)"
                        },
                      },
                    },
                    children: [
                      {
                        type: "panel",
                        children: [
                          {
                            type: "image",
                            vars: [
                              {
                                name: "imageUrl",
                                type: "exp",
                                exp: "((!$app.home.boards.selected) ? null : `https://i.4cdn.org/${$app.home.boards.selected.board}/${$item?.tim}${$item?.ext}`)"
                              }
                            ]
                          },
                        ]
                      },
                      {
                        type: "panel",
                        layout: {
                          size: {
                            width: "60%"
                          }
                        },
                        children: [
                          {
                            type: "text",
                            size: 3,
                            vars: [
                              {
                                name: "text",
                                type: "field",
                                exp: "sub"
                              }
                            ]
                          },
                          {
                            type: "text",
                            size: 5,
                            vars: [
                              {
                                name: "text",
                                type: "field",
                                exp: "com"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        type: "text",
                        size: 3,
                        vars: [
                          {
                            name: "text",
                            type: "field",
                            exp: "replies"
                          }
                        ]
                      },
                    ],
                  },
                ]
              },
              {
                type: "comp",
                name: "post",
                children: [
                  {
                    type: "panel",
                    children: [
                      {
                        type: "image",
                        layout: {
                          size: {
                            width: "20%"
                          }
                        },
                        vars: [
                          {
                            name: "imageUrl",
                            type: "exp",
                            exp: "((!$app.home.boards.selected) ? null : `https://i.4cdn.org/${$app.home.boards.selected?.board}/${$item?.tim}${$item?.ext}`)"
                          }
                        ]
                      },
                      {
                        type: "text",
                        size: 3,
                        vars: [
                          {
                            name: "text",
                            type: "field",
                            exp: "com"
                          }
                        ]
                      },
                    ],
                  },
                ]
              },
              {
                type: "comp",
                name: "generator",
                children: [
                  {
                    type: "panel",
                    children: [
                      {
                        type: "image",
                      },
                      {
                        type: "text",
                        size: 3,
                        data: {
                          source: {
                            exp: "name"
                          }
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      };

      const emptyUserApp = {
        type: "user.app",
        ui: {
          selected: {
            page: null,
            nodes: [],
            tool: {
              category: {
                index: null
              }
            }
          }
        },
        global: {
          design: {
            palette: null
          },
          page: {
            anim: {
              "name": "slide-x",
              "enter": {
                "from": {
                  "transform": "translateX(100%)",
                  "opacity": 0
                }
              },
              "leave": {
                "to": {
                  "transform": "translateX(-100%)",
                  "opacity": 0
                }
              }
            }
          }
        },
        children: [
          {
            type: "page.templates",
            children: [
              {
                type: "page.template",
                name: "default",
                children: [
                  {
                    type: "panel",
                    layout: {},
                    children: [
                      {
                        type: "text",
                        size: 3,
                        vars: [
                          {
                            name: "text",
                            type: "value",
                            value: "[🍏 clever app]"
                          }
                        ]
                      },
                      {
                        type: "slot.outlet",
                        name: "header"
                      }
                    ]
                  },
                  {
                    type: "panel",
                    layout: {
                    },
                    children: [
                      {
                        type: "slot.outlet",
                        name: "content"
                      }
                    ]
                  },
                ]
              }
            ]
          },
          {
            type: "pages",
            children: [
              {
                type: "page",
                name: "home",
                page: {
                  template: {
                    name: "default"
                  },
                },
                children: [
                  {
                    type: "slot.content",
                    slot: {
                      name: "header"
                    },
                    children: [
                      {
                        type: "text",
                        size: 1,
                        vars: [
                          {
                            name: "text",
                            type: "value",
                            value: "Home page"
                          }
                        ]
                      },
                    ]
                  },
                  {
                    type: "slot.content",
                    slot: {
                      name: "content"
                    },
                    children: [
                    ]
                  },
                ]
              },
            ]
          },
          {
            type: "comps",
            children: [
            ]
          }
        ]
      };

      const userApp = Objects.clone(emptyUserApp);

      const initNode = (node, depth) => {
        if (!node.type) return;
        const mockupNode = this.$root.initNewNode(userApp, node);
        const nodeProps = Objects.clone(node, { exclude: ["children"] });
        const merged = Objects.deepMerge(nodeProps, mockupNode);
        Object.assign(node, merged);
      }

      TreeObject.traverse(userApp, initNode);

      return userApp;
    }
  getStudioApp: | #js
    function(vue) {
      while (vue && (vue != this)) vue = vue.$parent;
      return vue;
    }
  getUserApp: | #js
    function(vue) {
      while (vue && !vue.userApp) vue = vue.$parent;
      return vue.userApp;
    }

watch:
  sui:
    deep: true
    handler: | #js
      function(sui) {
        sui.node.active = (sui.node.selected || sui.node.hovered);
      }
  appStateChangeKey: | #js
    async function() {
      const vars = [...this.appStateChangedVars];
      this.appStateChangedVars.clear();
      await this.$nextTick();
      this.$root.e.emit("app.state.changed", vars);
    }
  isUserAppTilted: | #js
    function(newValue) {
      this.sui.app.is.tilted = newValue;
      this.sui.tool.grid.lines = newValue;
    }

computed:
  isUserAppTilted: | #js
    function() {
      return (this.sui.main.box.hovered == 1);
    }
  appStylesheet: | #js
    function() {
      const s = {};
      s[`[data-node-id="${this.sui.node.hovered?.id}"]`] = {
        border: '2px dashed #ffff0080'
      };
      s[`[data-node-id="${this.sui.node.selected?.id}"]`] = {
        border: '2px dashed green'
      };
      if (this.sui.tool.grid.lines) {
        const pageName = this.sui.page.selected?.name;
        //s[`.studio-doc-node[data-sui-page=${pageName}]`] = {
        //  border: '1px dashed gray'
        //};
      }
      return s;
    }

style:
  .logo:
    position: fixed
    top: 1em
    right: 1em
    background: url(https://i.imgur.com/FJgDKYo.png)
    background-repeat: no-repeat
    width: 10vw
    aspect-ratio: 1
    background-position: center
    background-size: cover
  .spacer0:
    height: 3em
  .spacer1:
    height: 3em
  .spacer2:
    height: 1em
  .title1:
    font-size: 300%
  .title2:
    font-size: 200%
  .title3:
    margin-right: 1rem
    font-size: 140%
    text-shadow: -3px 3px 2px black
  .comp-studio-app:
    min-height: 100vh
    background: "radial-gradient(circle at center, #2f4e66, #000)"
    overflow: hidden
  .main-boxes:
    display: flex
    justify-content: space-between
    gap: 2em
    margin: 0 2vw
  .main-box:
    width: 25%
    transition: 0.4s
    perspective: 60vw
  .main-box .box2:
    overflow: hidden
  .user-app-container:
    overflow: hidden
  .main-boxes > *:nth-child(3) .box2:
    max-height: 70vh
    overflow: auto
    transform: rotateY(0deg)
    transform-style: preserve-3d
    transition: 0.6s
  .main-boxes > *:nth-child(3) .box2.user-app-tilted:
    # transform: rotateY(10deg)
  .user-app-tilted .studio-doc-node .list-item:
    opacity: 1
  .box2 *:
    transform-style: preserve-3d
  .box2:
    height: fit-content
    background: black
    border: 3px solid gray
    box-shadow: "-0.5em 0.5em 2px #00000080"
    padding: 1em
  .main-box.a:
    width: 10%
  .main-box.b:
    width: 15%
  .main-boxes.box-hovered-0 .main-box.a:
    width: 35%
  .main-boxes.box-hovered-0 .main-box.d:
    width: 10%
  .main-boxes.box-hovered-0 .main-box.e:
    width: 10%
  .main-boxes.box-hovered-3 .main-box.d:
    width: 35%
  .main-boxes.box-hovered-3 .main-box.e:
    width: 15%
  .main-boxes.box-hovered-4 .main-box.d:
    width: 15%
  .main-boxes.box-hovered-4 .main-box.e:
    width: 35%
  .flex2:
    display: flex
    flex-direction: column
    gap: 1em
  .tree-node:
    grid-template: 1fr / 0em 1fr
