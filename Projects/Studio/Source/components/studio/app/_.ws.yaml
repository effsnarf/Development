dom:
  div:
    studio.app.logo:
    .spacer1:
      v-text: "''"
    .main-boxes:
      v-if: userApp
      :class: "{ ['box-hovered-' + sui.main.box.hovered]: true }"
      .main-box.a:
        ui.drawer:
          .box2:
            studio.dom.tree:
              :root: userApp
              :sui: sui
        @mouseenter: sui.main.box.hovered = 0
        @mouseleave: sui.main.box.hovered = null
      .main-box.b:
        studio.app.ui.drawer:
          closed-width: 8em
          studio.doc.node.toolbar:
        .box2:
          transition.group:
            name: list2
            studio.dom.tree:
              v-for: pageNode in pageNodes
              :key: pageNode.id
              v-show: (pageNode.id == sui.page.selected?.id)
              :root: pageNode
              :sui: sui
              :initial-expanded: "true"
        studio.app.log:
          category: runtime
        @mouseenter: sui.main.box.hovered = 1
        @mouseleave: sui.main.box.hovered = null
      .main-box.c:
        studio.app.ui.drawer:
          closed-width: 8em
          studio.doc.page.selector:
            :user-app: userApp
            :user-app-state: userAppState
            :sui: sui
            :value: sui.page.selected
            @input: selectPage
        .box2:
          class: flex-grow-1
          :class: "{ 'user-app-tilted': sui.app.is.tilted }"
          @mouseenter: () => onHoverApp(true)
          @mouseleave: () => onHoverApp(false)
          studio.doc.node.picker:
            :user-app: userApp
            :sui: sui
            :enabled: sui.app.is.hovered
          studio.app.runtime:
            ref: userAppRuntime1
            :user-app: userApp
            :sui: sui
            @runtime-vue-inited: onRuntimeVueInited
        @mouseenter: sui.main.box.hovered = 2
        @mouseleave: sui.main.box.hovered = null
      .main-box.d:
        studio.app.ui.drawer:
          :open: "true"
          h2:
            :style: "{ 'margin-top': '1.3em' }"
            studio.dom.tree.node:
              :item: sui.node.selected
              :sui: sui
        .box2:
          studio.doc.node.editor:
            :node: sui.node.selected
            :user-app: userApp
            :user-app-state: userAppState
            :sui: sui
            :is-tabs-drawer-open: "true"
        @mouseenter: sui.main.box.hovered = 3
        @mouseleave: sui.main.box.hovered = null
      .main-box.e:
        studio.app.global.settings:
          :user-app: userApp
          :user-app-state: userAppState
          :sui: sui
        @mouseenter: sui.main.box.hovered = 4
        @mouseleave: sui.main.box.hovered = null
    studio.dom.tree.methods:
      ref: methods1
      :user-app: userApp
    studio.app.ui.trash.can:
      :user-app: userApp
    ui.css.stylesheet:
      :rules: userAppStylesheet

data:
  userApp:
  userAppState:
  sui:
    app:
      is:
        hovered:
        tilted:
    grid:
      lines:
    tool:
      category:
      grid:
        lines: false
    main:
      box:
        hovered: null
    design:
      selected:
        tab: 
        moods:
    page:
      selected:
      trans:
        dir:
        preview: false
    pages:
    node:
      hovered:
      selected:
      active:
      context:
      tree:
        is:
          hovered:
    nodes:
      hovered:
    selected:
      dataItems: []
    debug: true
  pageNodes:
  appStateChangedVars: []
  appStateChangeKey: 1

mounted: | #js
  async function() {
    this.userApp = this.getMockupUserApp();
    await this.$nextTick();
    this.pageNodes = this.$root.getPageNodes();
    // Register global methods
    this.$root.getUserApp = this.getUserApp.bind(this);
    this.$root.getStudioApp = this.getStudioApp.bind(this);
    this.$root.studio = {
      user: {
        app: {
          state: {
            change: (varPath, newValue, info) => {
              varPath = (varPath.split?.('.') || varPath);
              const oldValue = Objects.getProperty(this.userAppState, varPath);
              if (newValue == oldValue) return;
              Objects.setProperty(this.userAppState, varPath, newValue);
              this.appStateChangedVars.push({ varPath, newValue, info });
              this.appStateChangeKey++;
            }
          }
        },
        comp: {
          state: {
            change: ($root, vue, key, varPath, newValue) => {
              $root.studio.user.app.state.change(varPath, newValue);
            }
          }
        }
      }
    }
    this.$watch("sui.page.selected", this.onSelectedPageChanged.bind(this));
    this.$watch("sui.node.selected", this.onSelectedNodeChanged.bind(this));
    this.$root.$on("data.item.selected", this.onDataItemSelected.bind(this));
  }

methods:
  onSelectedPageChanged: | #js
    function(pageNode) {
      if (!pageNode) return;
      this.initPageUiState(pageNode);
      const sui = this.sui;
      const page = sui.pages[pageNode.id];
      // when switching page, set the selected node to the page's selected node
      sui.node.selected = page.node.selected;
    }
  onSelectedNodeChanged: | #js
    function(node) {
      this.sui.pages[this.sui.page.selected.id].node.selected = node;
      this.sui.selected.dataItems.clear();
    }
  onDataItemSelected: | #js
    function(dataItem) {
      this.sui.selected.dataItems.push(dataItem);
    }
  initPageUiState: | #js
    function(pageNode) {
      if (!pageNode) return;
      // init sui.pages[(page-id)] to hold separate ui state for pages
      const sui = this.sui;
      sui.pages = (sui.pages || {});
      sui.pages[pageNode.id] = (this.sui.pages[pageNode.id] || {});
      const page = sui.pages[pageNode.id];
      page.node = (page.node || {});
      page.node.selected = (page.node.selected || null);
    }
  onRuntimeVueInited: | #js
    function() {
      this.userAppState =  this.$refs.userAppRuntime1.$refs.userAppVue1.$data;
    }
  onHoverApp: | #js
    function(isHovered) {
      this.sui.app.is.hovered = isHovered;
    }
  selectPage: | #js
    function(newPage) {
      this.sui.page.trans.dir = this.getPageTransDir(this.sui.page.selected, newPage);
      this.sui.page.selected = newPage;
      const node = this.sui.node;
      node.hovered = node.selected = node.active = node.context = null;
    }
  getPageTransDir: | #js
    function(fromPage, toPage) {
      if (!fromPage?.id || !toPage?.id) return null;
      if (toPage.id > fromPage.id) return "next";
      if (fromPage.id > toPage.id) return "prev";
    }
  onSuiEvent: | #js
    function(suiFunc) {
      suiFunc(this.sui);
    }
  onDomEditEvent: | #js
    function(editFunc) {
      editFunc();
    }
  getMockupUserApp: | #js
    function() {
      const userApp = {
        type: "user.app",
        global: {
          design: {
            palette: null
          },
          page: {
            anim: {
              "name": "slide-x",
              "enter": {
                "from": {
                  "transform": "translateX(100%)",
                  "opacity": 0
                }
              },
              "leave": {
                "to": {
                  "transform": "translateX(-100%)",
                  "opacity": 0
                }
              }
            }
          }
        },
        children: [
          {
            type: "layouts",
            children: [
              {
                type: "layout",
                name: "default",
                children: [
                  {
                    type: "panel",
                    flex: {
                      direction: "v"
                    },
                    layout: {
                      position: "fixed",
                      top: 0
                    },
                    children: [
                      {
                        type: "text",
                        text: "Meme Generator",
                        size: 3
                      },
                      {
                        type: "slot.outlet",
                        name: "header"
                      }
                    ]
                  },
                  {
                    type: "panel",
                    layout: {
                      position: "fixed",
                      top: "10vh",
                      size: {
                        height: "90vh"
                      }
                    },
                    children: [
                      {
                        type: "slot.outlet",
                        name: "content"
                      }
                    ]
                  },
                ]
              }
            ]
          },
          {
            type: "pages",
            children: [
              {
                type: "page",
                name: "home",
                layout: {
                  name: "default"
                },
                children: [
                  {
                    type: "slot.content",
                    slot: {
                      name: "header"
                    },
                    children: [
                      {
                        type: "text",
                        size: 1,
                        vars: [
                          {
                            name: "text",
                            type: "value",
                            value: "Home page"
                          }
                        ]
                      },
                    ]
                  },
                  {
                    type: "slot.content",
                    slot: {
                      name: "content"
                    },
                    children: [
                      {
                        type: "ui.input.text.box",
                        vue: {
                          props: {
                            type: "search",
                            hint: "search",
                            icon: "ðŸ”Ž",
                          }
                        }
                      },
                      {
                        type: "list",
                        name: "boards",
                        flex: {
                          justify: {
                            content: "center"
                          }
                        },
                        vars: [
                          {
                            name: "items",
                            type: "fetch",
                            url: "`https://a.4cdn.org/boards.json`",
                            linq: [{"type":"select.field","path":["boards"],"_id":1},{"type":"select.fields","fields":["board","title"],"_id":2}]
                          },
                          {
                            name: "hovered",
                            type: "value",
                          },
                          {
                            name: "selected",
                            type: "value",
                          }
                        ],
                        children: [
                          {
                            type: "text",
                            size: 2,
                            vars: [
                              {
                                name: "text",
                                type: "field",
                                exp: "title"
                              }
                            ]
                          }
                        ]
                      },
                    ]
                  },
                ]
              },
              {
                type: "page",
                name: "board",
                layout: {
                  name: "default"
                },
                children: [
                  {
                    type: "slot.content",
                    slot: {
                      name: "header"
                    },
                    children: [
                      {
                        type: "text",
                        size: 1,
                        vars: [
                          {
                            name: "text",
                            type: "exp",
                            exp: "this.home.boards.selected.title",
                          }
                        ]
                      },
                    ]
                  },
                  {
                    type: "slot.content",
                    slot: {
                      name: "content"
                    },
                    children: [
                      {
                        type: "list",
                        name: "threads",
                        vars: [
                          {
                            name: "items",
                            type: "fetch",
                            url: "`https://a.4cdn.org/${this.home.boards.selected.board}/catalog.json`",
                            linq: [{"type":"select.fields","fields":["threads"],"_id":1},{"type":"flat.map","path":["threads"],"_id":2}]
                          },
                          {
                            name: "hovered",
                            type: "value",
                          },
                          {
                            name: "selected",
                            type: "value",
                          }
                        ],
                        children: [
                          {
                            type: "comp.inst",
                            comp: {
                              name: "thread.teaser"
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                type: "page",
                name: "thread",
                layout: {
                  name: "default"
                },
                children: [
                  {
                    type: "slot.content",
                    slot: {
                      name: "header"
                    },
                    children: [
                      {
                        type: "text",
                        size: 1,
                        vars: [
                          {
                            name: "text",
                            type: "exp",
                            exp: "this.board.threads.selected.sub"
                          }
                        ]
                      },
                    ]
                  },
                  {
                    type: "slot.content",
                    slot: {
                      name: "content"
                    },
                    children: [
                      {
                        type: "list",
                        name: "posts",
                        data: {
                          vars: [
                            {
                              name: "items",
                              type: "fetch",
                              url: "`https://a.4cdn.org/${this.home.boards.selected.board}/thread/${this.board.threads.selected.no}.json`",
                              linq: [ { "type": "select.field", "path": [ "posts" ], "_id": 1 } ]
                            }
                          ],
                        },
                        children: [
                          {
                            type: "comp.inst",
                            comp: {
                              name: "post"
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            type: "comps",
            children: [
              {
                type: "comp",
                name: "thread.teaser",
                children: [
                  {
                    type: "panel",
                    flex: {
                      direction: "h",
                      justify: {
                        content: "space-between"
                      }
                    },
                    children: [
                      {
                        type: "panel",
                        layout: {
                          size: {
                            width: "20%"
                          }
                        },
                        children: [
                          {
                            type: "image",
                            vars: [
                              {
                                name: "imageUrl",
                                type: "exp",
                                exp: "`https://i.4cdn.org/${this.home.boards.selected.board}/${tim}${ext}`"
                              }
                            ]
                          },
                        ]
                      },
                      {
                        type: "panel",
                        layout: {
                          size: {
                            width: "60%"
                          }
                        },
                        children: [
                          {
                            type: "text",
                            size: 3,
                            vars: [
                              {
                                name: "text",
                                type: "field",
                                exp: "sub"
                              }
                            ]
                          },
                          {
                            type: "text",
                            size: 5,
                            vars: [
                              {
                                name: "text",
                                type: "field",
                                exp: "com"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        type: "text",
                        size: 3,
                        vars: [
                          {
                            name: "text",
                            type: "field",
                            exp: "replies"
                          }
                        ]
                      },
                    ],
                  },
                ]
              },
              {
                type: "comp",
                name: "post",
                children: [
                  {
                    type: "panel",
                    flex: {
                      direction: "h",
                      justify: {
                        content: "flex-start"
                      }
                    },
                    children: [
                      {
                        type: "image",
                        layout: {
                          size: {
                            width: "20%"
                          }
                        },
                        vars: [
                          {
                            name: "imageUrl",
                            type: "exp",
                            exp: "`https://i.4cdn.org/${this.home.boards.selected.board}/${tim}${ext}`"
                          }
                        ]
                      },
                      {
                        type: "text",
                        size: 3,
                        vars: [
                          {
                            name: "text",
                            type: "field",
                            exp: "com"
                          }
                        ]
                      },
                    ],
                  },
                ]
              },
              {
                type: "comp",
                name: "generator",
                children: [
                  {
                    type: "panel",
                    flex: {
                      direction: "h",
                      justify: {
                        content: "flex-start"
                      }
                    },
                    children: [
                      {
                        type: "image",
                      },
                      {
                        type: "text",
                        size: 3,
                        data: {
                          source: {
                            exp: "name"
                          }
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      };

      const initNode = (node) => {
        if (!node.type) return;
        node.id = this.$root.getNewNodeID(userApp);
        const mockupNode = this.$root.initNewNode(userApp, node);
        const nodeProps = Objects.clone(node, { exclude: ["children"] });
        const merged = Objects.deepMerge(nodeProps, mockupNode);
        Object.assign(node, merged);
      }

      TreeObject.traverse(userApp, initNode);

      return userApp;
    }
  getStudioApp: | #js
    function(vue) {
      while (vue && (vue != this)) vue = vue.$parent;
      return vue;
    }
  getUserApp: | #js
    function(vue) {
      while (vue && !vue.userApp) vue = vue.$parent;
      return vue.userApp;
    }

watch:
  sui:
    deep: true
    handler: | #js
      function(sui) {
        sui.node.active = (sui.node.selected || sui.node.hovered);
      }
  appStateChangeKey: | #js
    function() {
      const vars = [...this.appStateChangedVars];
      this.appStateChangedVars.clear();
      this.$root.$emit("app.state.changed", vars);
    }
  isUserAppTilted: | #js
    function(newValue) {
      this.sui.app.is.tilted = newValue;
      this.sui.tool.grid.lines = newValue;
    }

computed:
  isUserAppTilted: | #js
    function() {
      return (this.sui.main.box.hovered == 1);
    }
  userAppStylesheet: | #js
    function() {
      const s = {};
      if (this.sui.tool.grid.lines) {
        const pageName = this.sui.page.selected?.name;
        s[`.studio-doc-node[data-sui-page=${pageName}]`] = {
          border: '1px dashed gray'
        };
      }
      return s;
    }

style:
  .spacer1:
    height: 4em
  .title1:
    font-size: 300%
  .title2:
    font-size: 200%
  .title3:
    margin-right: 1rem
    font-size: 140%
    text-shadow: -3px 3px 2px black
  .comp-studio-app:
    min-height: 100vh
    background: "radial-gradient(circle at center, #2f4e66, #000)"
  .main-boxes:
    display: flex
    justify-content: space-between
    gap: 2em
    margin: 0 2vw
  .main-box:
    width: 25%
    transition: 0.4s
    perspective: 60vw
  .main-box .box2:
    overflow: hidden
  .user-app-container:
    overflow: hidden
  .main-boxes > *:nth-child(3) .box2:
    transform: rotateY(0deg)
    transform-style: preserve-3d
    transition: 0.6s
  .main-boxes > *:nth-child(3) .box2.user-app-tilted:
    transform: rotateY(10deg)
  .user-app-tilted .studio-doc-node .list-item:
    opacity: 1
  .box2 *:
    transform-style: preserve-3d
  .box2:
    height: fit-content
    background: black
    border: 3px solid gray
    box-shadow: "-0.5em 0.5em 2px #00000080"
    padding: 1em
  .main-box.a:
    width: 10%
  .main-boxes.box-hovered-3 .main-box.d:
    width: 46%
  .main-boxes.box-hovered-3 .main-box.e:
    width: 4%
  .main-boxes.box-hovered-4 .main-box.d:
    width: 4%
  .main-boxes.box-hovered-4 .main-box.e:
    width: 46%
  .flex2:
    display: flex
    flex-direction: column
    gap: 1em
  .tree-node:
    grid-template: 1fr / 0em 1fr
