dom:
  div:
    studio.doc.node.user.app:
      :user-app: userApp
      :user-app-state: userAppState
      :sui: sui
    studio.app.runtime.common:
      ref: common1
    ui.linq.evaluator:
      ref: linqEval1

props:
  userApp:
  sui:

data:
  userAppState:

mounted: | #js
  function() {
    this.initAppState();
    this.$root.$on("app.node.changed", this.onAppNodeChanged.bind(this));
    this.$root.$on("app.state.changed", this.onAppStateChanged.bind(this));
  }

methods:
  initAppState: | #js
    function() {
      this.userAppState = this.getNewAppState(this.userApp);
      this.$emit("user-app-state", this.userAppState);
    }
  updateAppState: | #js
    function() {
      const oldAppState = this.userAppState;
      const newAppState = this.getNewAppState(this.userApp);
      this.userAppState = newAppState;
      this.$emit("user-app-state", this.userAppState);
    }
  getNewAppState: | #js
    function(userApp) {
      const data = {};
      for (const pageNode of this.$root.getPageNodes()) {
        const pageData = {};
        // lists
        for (const node of this.$root.findDescNodes(pageNode, ((n) => n.vars?.length)))
        {
          const ds = node.data?.source;
          const listVarPath = `${pageNode.name}.${node.name}`;
          const listVarName = listVarPath.replaceAll('.', '_');

          pageData[node.name] = {};

          if (node.vars) {
            for (const var1 of node.vars) {
              pageData[node.name][var1.name] = null;
            }
          }
        }
        data[pageNode.name] = pageData;
      }
      return data;
    }
  onAppNodeChanged: | #js
    function() {
      this.updateAppState();
    }
  onAppStateChanged: | #js
    function(vars) {
      if (vars.any(v => v.varPath.includes("hovered"))) return;
      // #TODO lame
      this.$forceUpdate();
    }
