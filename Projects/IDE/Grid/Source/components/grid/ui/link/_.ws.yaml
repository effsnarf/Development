dom:
  grid.module:
    ':show-title': 'false'
    div: 
      v-if: 'false'
      ':class': '{ hoverable: true, ''opacity-30'': (!showLeaderLine) }'
      @mouseenter: isHighlighted = true
      @mouseleave: isHighlighted = false
      div: 
        v-text: linkDesc
      ui.context.window:
        ui.value:
          ':value': link
    ui.leader.line:
      v-if: showLeaderLine
      ref: leaderLine1
      ':from': fromEl
      ':to': toEl
      ':start-plug': getStartPlug()
      ':color': leaderLineColor
      template:
        v-slot: middle
        div: 
          v-if: 'true'
          class: show-on-hover-container
          ':style': '{ ''min-width'': ''10em'', height: ''3em'', ''z-index'': 1000 }'
          ui.button:
            class: show-on-hover
            icon: âŒ
            ':text': linkDesc
            @click: deleteLink
props:
  link: null
data:
  flashingValue: null
  fromEl: null
  toEl: null
  linkDesc: null
  normalColor: '#404040'
  highlightedColor: cyan
  leaderLineColor: '#404040'
  isHighlighted: false
mounted: | #js
  function() {
    this.refresh();
  }
methods:
  deleteLink: | #js
    function() {
      this.$femit("delete.link", this.link._id);
    }
  grid_user_action_stack_do: | #js
    function(box) {
      this.refresh();
    }
  grid_client_runtime_link_flash: | #js
    async function(linkID, sValue) {
      // #TODO: Slow
      if (linkID !== this.link._id) return;
      
      const vLeaderLine = this.$root.vm.getDescendant(this, "ui.leader.line");
      vLeaderLine?.flash(sValue);

      //this.flashingValue = sValue;
      await this.$nextTick();
      this.flashingValue = null;
    }
  getFromEl: | #js
    function() {
      return this.getSocketEl(this.link.from, 'output');
    }
  getToEl: | #js
    function() {
      const toGroupBox = this.getTopGroupBox(this.link.to.box);
      // If the link is going to a box inside a group box, we need to find the group box's window
      // If this box is not a member of the group box
      if (toGroupBox)
      {
        if ((toGroupBox._id != this.link.to.box._id)) {
          //return this.$root.els[`/box/window/${toBox._id}`];
        }
      }
      return this.getSocketEl(this.link.to, 'input');
    }
  getStartPlug: | #js
    function() {
      if (this.link.from.socket.type === "iterator") return "arrow1";
      return null;
    }
  getSocketEl: | #js
    function(socketRef, direction) {
      if (!this.$root.els) {
        setTimeout(this.refresh.bind(this), 100);
        return null;
      }
      const socketElPath = this.getSocketElPath(socketRef, direction);
      return this.$root.els[socketElPath];
    }
  getSocketElPath: | #js
    function(socketRef, direction) {
      const socketElPath = `/box/${socketRef.box._id}/sockets/${direction}/${socketRef.socket._id}`;
      return socketElPath;
    }
  getTopGroupBox: | #js
    function(boxRef) {
      if (!boxRef) return null;
      const box = this.$root.boxes.find(b => b._id == boxRef._id);
      if (!box) return null;
      if (box.groupBoxID) return this.getTopGroupBox({ _id: box.groupBoxID });
      return box;
    }
  getLinkDesc: | #js
    function() {
      const fromBox = this.$root.boxes.find(b => b._id == this.link.from.box._id);
      const toBox = this.$root.boxes.find(b => b._id == this.link.to.box._id);
      if (!fromBox?.sockets || !toBox?.sockets) return "";
      const fromSocket = fromBox.sockets.output.find(s => s._id == this.link.from.socket._id);
      const toSocket = toBox.sockets.input.find(s => s._id == this.link.to.socket._id);
      const fromSocketIcon = this.getSocketIcon(fromSocket);
      const toSocketIcon = this.getSocketIcon(toSocket);
      return `${fromSocketIcon}${fromSocket.name} -> ${toSocketIcon}${toSocket.name}`;
    }
  getSocketIcon: | #js
    function(socket) {
      return {
        data: 'ðŸ§Š',
        iterator: 'ðŸ”—ðŸ–‡ï¸',
        view: 'â¬œ',
        event: 'âš¡',
      }[socket?.type];
    }
  refresh: | #js
    function(again = 10) {
      this.fromEl = this.getFromEl();
      this.toEl = this.getToEl();
      this.linkDesc = this.getLinkDesc();
      if (again) setTimeout(this.refresh.bind(this, again - 1), 400);
    }
computed:
  showLeaderLine: | #js
    function() {
      if (!this.link) return false;
      if (this.link.is.grouped) return false;
      return this.link.is.visible;
    }
watch:
  isHighlighted: | #js
    function(isHighlighted) {
      if (!this.$refs.leaderLine1) return;
      this.leaderLineColor = (isHighlighted ? this.highlightedColor : this.normalColor);
    }
  showLeaderLine: | #js
    function() {
      this.refresh();
    }
_:
  examples:
    count: 0
name: grid-ui-link
template: >-
  <grid-module class="comp-grid-ui-link" :show-title="false"
  path="281201772."><div v-if="false" :class="{ hoverable: true, 'opacity-30':
  (!showLeaderLine) }" @mouseenter="isHighlighted = true"
  @mouseleave="isHighlighted = false" path="281201772.0"><div v-text="linkDesc"
  path="281201772.0.0"></div><ui-context-window path="281201772.0.1"><ui-value
  :value="link"
  path="281201772.0.1.0"></ui-value></ui-context-window></div><ui-leader-line
  v-if="showLeaderLine" ref="leaderLine1" :from="fromEl" :to="toEl"
  :start-plug="getStartPlug()" :color="leaderLineColor"
  path="281201772.1"><template v-slot:middle path="281201772.1.0"><div
  class="show-on-hover-container" v-if="true" :style="{ 'min-width': '10em',
  height: '3em', 'z-index': 1000 }" path="281201772.1.0.0"><ui-button
  class="show-on-hover" icon="âŒ" :text="linkDesc" @click="deleteLink"
  path="281201772.1.0.0.0"></ui-button></div></template></ui-leader-line></grid-module>
