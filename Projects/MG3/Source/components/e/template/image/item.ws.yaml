dom:
  div:
    ui.loading:
      class: absolute-center
      v-show: isLoading
    ui.file.dropzone:
      v-show: '!isLoading'
      @file-drop: onFileDrop(item, $event)
      ui.movable:
        @drag-by: ({ dx, dy }) => onItemDragBy(item, { dx, dy })
        @scale-by: (ds) => onItemScaleBy(item, ds)
        ui.image:
          ref: image1
          v-if: item
          ':style': itemStyle
          ':imageID': item.imageID
          ':remove-background': item.removeBackground
          @load: onImageLoad
          @change: refresh
    e.template.caption.item:
      v-if: item.caption
      ':item': item.caption
props:
  item: null
data:
  itemStyle: null
  isLoading: 0
methods:
  onFileDrop: | #js
    async function(item, files) {
      await this.$nextTick();
      if (files.length > 1) return alertify.error('One file at a time, please');
      this.isLoading++;
      try
      {
        const image = await this.$root.uploadFile(files[0]);
        item.imageID = image._id;
      }
      finally
      {
        this.isLoading--;
      }
    }
  onItemDragBy: | #js
    function(item, dpos) {
      const pos = item.trans.pos;
      pos.x += dpos.dx;
      pos.y += dpos.dy;
    }
  onItemScaleBy: | #js
    function(item, ds) {
      item.trans.scale += ds;
    }
  refresh: | #js
    function() {
      this.itemStyle = this.getStyle(this.item);
    }.throttle(50)
  onImageLoad: | #js
    function(e) {
      this.$emit('image-load', e);
    }
  getStyle: | #js
    function(item) {
      if (!item) return;
      let style = {};
      style.transform = `translate(${(-0.5 + item.trans.pos.x) * 100}%, ${(-0.5 + item.trans.pos.y) * 100}%) scale(${item.trans.scale})`;
      const cssFilters = [];
      const image1 = this.$refs.image1;
      if (image1 && item.shadow)
      {
        // Apply the opacity to the shadow color
        const color = item.shadow.color.replace(/#(..)(..)(..)/, (match, r, g, b) => {
          const opacity = Math.round(item.shadow.opacity*255).toString(16);
          return `#${r}${g}${b}${opacity}`;
        });
        const values = {
          x: (item.shadow.x*image1.width).toFixed(2),
          y: (item.shadow.y*image1.height).toFixed(2),
          blur: item.shadow.blur/20*image1.diagonal.toFixed(2),
          color: color
        };
        const dropShadow = `drop-shadow(${values.x}px ${values.y}px ${values.blur}px ${values.color})`;
        cssFilters.push(dropShadow);
      }
      style.filter = cssFilters.join(' ');
      return style;
    }
watch:
  item:
    handler: | #js
      function(item) {
        this.refresh();
      }
    deep: true
style:
  .comp-e-template-caption-item:
    position: absolute
    top: 0
    width: 100%
    height: 100%
    pointer-events: none
name: e-template-image-item
template: >-
  <div class="comp-e-template-image-item" path="1623568049."><ui-loading
  class="absolute-center" v-show="isLoading"
  path="1623568049.0"></ui-loading><ui-file-dropzone v-show="!isLoading"
  @file-drop="onFileDrop(item, $event)" path="1623568049.1"><ui-movable
  @drag-by="({ dx, dy }) =&gt; onItemDragBy(item, { dx, dy })" @scale-by="(ds)
  =&gt; onItemScaleBy(item, ds)" path="1623568049.1.0"><ui-image ref="image1"
  v-if="item" :style="itemStyle" :imageID="item.imageID"
  :remove-background="item.removeBackground" @load="onImageLoad"
  @change="refresh"
  path="1623568049.1.0.0"></ui-image></ui-movable></ui-file-dropzone><e-template-caption-item
  v-if="item.caption" :item="item.caption"
  path="1623568049.2"></e-template-caption-item></div>
