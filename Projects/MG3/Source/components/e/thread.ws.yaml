dom:
  div: 
    div: 
      transition.group:
        tag: ul
        name: slide
        li:
          v-for: (post, index) in visiblePosts
          ':key': post?._id||0
          e.post:
            ':item': post
            @thread-updated: refresh
          .text-center.opacity-30:
            v-if: teaser && getHiddenPostsCount(index)
            v-text: '''('' + getHiddenPostsCount(index) + '' posts…)'''
      e.post.create:
        v-dim: isLoading
        ':threadID': thread?._id
        ':threadMedia': dThreadMedia
        @created: reload
      .mt-l2:
        class: hidden
        ui.button:
          v-if: $root.isAdmin
          ':text': '''♻ reload'''
          ':click': reload
props:
  threadID: null
  threadMedia: null
  teaser: false
data:
  thread: null
  dThreadMedia: null
  threadIsEmpty: false
  tasks: null
  key1: 1
  isLoading: 0
mounted: | #js
  async function() {
  }
methods:
  getHiddenPostsCount: | #js
    function(index) {
      const post = this.visiblePosts[index];
      const nextPost = this.visiblePosts[index + 1];
      if (!post || !nextPost) return null;
      return (nextPost.index - post.index - 1);
    }
  isRelevantThread: | #js
    function(thread) {
      if (!this.thread) return false;
      if (this.thead._id == thread?._id) return true;
      return false;
    }
  refresh: | #js
    function() {
      this.key1++;
    }
  reload: | #js
    async function() {
      if (!this.tasks) this.tasks = new TaskQueue();
      this.tasks.enqueue(this._reload);
    }
  _reload: | #js
    async function() {
      // Get the thread
      this.isLoading++;
      try
      {
        this.thread = await this.$root.dbp.threads.select.one(this.threadID, this.dThreadMedia?._id, this.dThreadMedia?.instance?._id);
        this.threadIsEmpty = !this.thread;
      }
      finally
      {
        this.isLoading--;
      }
    }
  clear: | #js
    function() {
      this.thread = null;
      this.threadIsEmpty = false;
    }
computed:
  visiblePosts: | #js
    function() {
      if (!this.thread) return [];
      let posts1 = [...this.thread.posts];
      // OP is shown on the left
      posts1.shift();
      // Sort by score
      posts1.sortBy(p => -p.totalVotesScore);
      if (!this.teaser) return posts1;

      // Thread teaser
      let vPosts = [];
      // Take the first two and the last two posts
      vPosts.push(...posts1.slice(0, 2));
      vPosts.push(...posts1.slice(-2));
      // Make sure there are no duplicates
      vPosts = vPosts.filter((post, index, self) => self.findIndex(p => p._id === post._id) === index);
      // Return
      return vPosts;
    }
watch:
  thread:
    handler: | #js
      function() {
        this.refresh();
      }
  threadID:
    handler: | #js
      async function(threadID) {
        await this.reload();
      }
    immediate: true
  threadMedia:
    handler: | #js
      async function(threadMedia, oldThreadMedia) {
        if (threadMedia?.instance?._id != oldThreadMedia?.instance?._id)
        {
          this.tasks.enqueue(this.clear);
          this.clear();
        }
        this.dThreadMedia = threadMedia;
        if (!threadMedia) return;
        if (this.dThreadMedia.instance)
        {
          // This instance may already have a media
          const existingInstanceMedia = await this.$root.dbp.medias.select.byInstance(this.dThreadMedia.instance._id);
          if (existingInstanceMedia)
          {
            this.dThreadMedia = existingInstanceMedia;
          }
          await this.reload();
        }
      }
    immediate: true
style:
  .comp-e-post-create:
    transition: opacity 0.1s
  .thread-columns:
    display: grid
    grid-template: 1fr / 1fr 1fr
    gap: 2vw
  ul:
    margin: auto
  li:
    margin-bottom: 1vh
name: e-thread
template: >-
  <div class="comp-e-thread" path="1226205107."><div
  path="1226205107.0"><transition-group tag="ul" name="slide"
  path="1226205107.0.0"><li v-for="(post, index) in visiblePosts"
  :key="post?._id||0" path="1226205107.0.0.0"><e-post :item="post"
  @thread-updated="refresh" path="1226205107.0.0.0.0"></e-post><div
  class="text-center opacity-30" v-if="teaser &amp;&amp;
  getHiddenPostsCount(index)" v-text="'(' + getHiddenPostsCount(index) + '
  posts…)'"
  path="1226205107.0.0.0.1"></div></li></transition-group><e-post-create
  v-dim="isLoading" :threadID="thread?._id" :threadMedia="dThreadMedia"
  @created="reload" path="1226205107.0.1"></e-post-create><div class="hidden
  mt-l2" path="1226205107.0.2"><ui-button v-if="$root.isAdmin" :text="'♻
  reload'" :click="reload"
  path="1226205107.0.2.0"></ui-button></div></div></div>
